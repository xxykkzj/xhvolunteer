# 寺院志愿者管理系统 - 功能实现状态汇报

**汇报日期**: 2025-01-01  
**系统版本**: v0.8 (Phase 1-8 基本完成)  
**整体完成度**: 约80%

---

## 一、已实现功能总览

### Phase 1-3: 基础架构与核心服务 ✅ 100%

**数据库架构**:
- 18张表完整设计并迁移
- 支持用户、部门、排班、考勤、积分、奖励、兑换、审计等全业务流程

**核心服务**:
- ✅ AES-256-CBC加密服务（敏感信息保护）
- ✅ HMAC-SHA256签名服务（兑换码防伪）
- ✅ 7级会员体系自动计算（欢喜地→远行地）
- ✅ 欢喜徽记自动授予（70小时门槛）
- ✅ RBAC权限控制（5级角色：volunteer/leader/manager/admin/super-admin）
- ✅ 审计日志服务（记录所有关键操作）

**认证系统**:
- ✅ 双重认证：Manus OAuth（管理员）+ 志愿者代码登录（志愿者）
- ✅ 用户注册自动生成志愿者代码（如V1730380123456）
- ✅ 用户管理CRUD（列表、查询、更新、删除）
- ✅ 角色管理（管理员可修改用户角色）
- ✅ 登录后自动初始化userRankSnapshot

---

### Phase 4: 部门与服务关系管理 ⚠️ 40%

#### ✅ 已完成
- **部门CRUD**：后端API（create/list/update/delete）+ 前端UI
- **部门管理页面**：创建、编辑、删除部门，带RBAC权限验证
- **权限控制**：仅经理/管理员可操作

#### ❌ 待完成（影响后续功能）
1. **Engagement管理**（义工/寺工关系）
   - 当前状况：数据库表已存在，但无API和UI
   - 影响：无法正式记录用户的服务类型（volunteer_shortterm vs temple_worker）
   - 重要性：**高** - 这是实现积分差异化的基础
   - 预计时间：3-4小时

2. **用户-部门分配**
   - 当前状况：可在排班时指定部门，但无法查询某部门的所有志愿者
   - 影响：权限控制不够细化，统计报表缺少部门维度
   - 重要性：**中** - 不影响核心流程，但影响管理效率
   - 预计时间：1-2小时

3. **14天最短服务期验证**
   - 当前状况：未实现业务规则验证
   - 影响：短期义工可能未满14天就结束服务
   - 重要性：**中** - 业务规则约束
   - 预计时间：1小时

4. **Engagement状态管理**
   - 当前状况：数据库支持active/inactive/suspended，但无UI操作
   - 影响：无法暂停或终止某个服务关系
   - 重要性：**低** - 可通过数据库操作
   - 预计时间：1小时

---

### Phase 5-6: 排班、考勤与工时追踪 ✅ 90%

#### ✅ 已完成（核心功能）
- **排班系统**：
  - 创建排班（日期、部门、班次时间、所需人数）
  - 分配志愿者到排班
  - 日历视图查看排班
  - 按部门筛选排班
  
- **考勤系统**：
  - 考勤确认界面（组长/经理操作）
  - 记录实际工时（支持与计划工时不同）
  - 自动记录到hours_ledger（工时账本）
  - 自动计算积分到point_ledger（积分账本）
  - 自动更新user_rank_snapshot（等级快照）
  - 欢喜徽记自动授予（累计70小时）
  
- **个人中心**：
  - 查看当前等级、累计积分、累计工时
  - 查看欢喜徽记状态
  - 查看积分历史（含工时记录）

#### ❌ 待完成（体验增强）
1. **我的排班视图**
   - 当前状况：志愿者无法查看自己的upcoming和past排班
   - 影响：用户体验差，志愿者需要手动记录排班信息
   - 重要性：**中** - 不影响核心功能，但严重影响用户体验
   - 预计时间：1-2小时

2. **寺工轮班规则（rota_rules）**
   - 当前状况：数据库表已存在，但无API和UI
   - 影响：固定班次的寺工需要手动创建每月排班
   - 重要性：**低** - 可手动操作，自动化程度降低
   - 预计时间：3-4小时
   - 依赖：Engagement管理

---

### Phase 7-8: 积分、奖励与兑换系统 ✅ 100%

#### ✅ 已完成（全部功能）
- **积分系统**：
  - 积分汇总查询（总积分、当前等级、徽记状态）
  - 积分账本查询（历史记录，含来源和时间）
  - 部门奖励积分申请（经理为志愿者申请额外积分）
  - 奖励积分审批流程（含月度配额验证，防止超额）
  
- **奖励商城**：
  - 公开访问（无需登录即可浏览）
  - 显示所有奖励（名称、描述、积分成本、等级要求、徽记要求）
  - 登录后显示用户的兑换资格（可兑换/条件未满足）
  - 当前有9个示例奖励（25-200积分不等）
  
- **兑换流程**：
  - 选择奖励 → 确认兑换 → 自动扣除积分
  - 生成HMAC-SHA256签名的兑换码（防伪造）
  - 兑换成功页面显示兑换码和QR占位符
  - 自动扣减奖励库存
  
- **工作人员验证**：
  - 专用验证界面（/verify，需leader以上角色）
  - 输入兑换码验证签名
  - 标记兑换码为"已使用"
  - 防止重复验证（幂等性）
  
- **兑换历史**：
  - 用户查看自己的兑换记录
  - 显示兑换时间、奖励名称、积分成本、状态

---

## 二、核心业务流程验证（已测试）

以下流程已通过端到端测试：

1. ✅ **用户注册流程**
   - 填写注册表单 → 自动生成志愿者代码 → 初始化积分快照（0积分，等级1）

2. ✅ **双重登录流程**
   - 管理员：点击"管理员登录" → Manus OAuth（Google账号）→ 跳转回系统
   - 志愿者：点击"志愿者登录" → 输入志愿者代码（如DEMO2025）→ 登录成功

3. ✅ **部门管理流程**
   - 管理员创建部门 → 编辑部门信息 → 删除部门 → RBAC权限验证通过

4. ✅ **排班考勤流程**
   - 经理创建排班（指定日期、部门、班次）→ 分配志愿者 → 日历查看
   - 服务结束后，组长确认考勤 → 记录实际工时 → 自动计算积分（1小时=10积分）
   - 系统自动更新志愿者的累计工时和等级
   - 累计70小时自动授予欢喜徽记

5. ✅ **奖励积分流程**
   - 经理为表现优秀的志愿者申请奖励积分 → 管理员审批 → 积分到账
   - 系统验证月度配额，防止超额发放

6. ✅ **兑换验证流程**
   - 志愿者浏览奖励商城 → 检查兑换资格（积分、等级、徽记）
   - 选择奖励 → 确认兑换 → 生成HMAC签名码
   - 工作人员在验证界面输入兑换码 → 验证签名 → 标记已使用
   - 防止重复验证和伪造兑换码

7. ✅ **个人中心流程**
   - 志愿者查看当前等级（如"欢喜地"）、累计积分、累计工时
   - 查看欢喜徽记状态
   - 查看积分历史（包括工时记录、奖励积分、兑换扣除）

8. ✅ **权限控制验证**
   - 5级角色（volunteer/leader/manager/admin/super-admin）权限隔离
   - 志愿者无法访问管理功能
   - 组长可确认考勤和验证兑换码
   - 经理可创建排班和申请奖励积分
   - 管理员可管理用户角色和审批奖励

9. ✅ **审计日志**
   - 所有关键操作（创建排班、确认考勤、兑换奖励、角色变更等）自动记录到audit_log表

---

## 三、待完成功能分析与优先级

### 🔴 高优先级（影响核心业务逻辑）

#### 1. Engagement管理（义工/寺工关系）
- **当前状况**：数据库表engagements已存在，包含type字段（volunteer_shortterm/temple_worker），但无API和UI
- **业务需求**：
  - 需要正式记录用户的服务类型（义工 vs 寺工）
  - 寺工工时更长，承担责任更多，积分率应该不同
  - 义工需要满足14天最短服务期
- **影响范围**：
  - 无法区分义工和寺工，导致积分计算无法差异化
  - 无法实现Phase 9的"部门/岗位工时积分率配置"
  - 统计报表缺少服务类型维度
- **预计时间**：3-4小时
- **开发内容**：
  - 后端：engagements router（create/list/update/delete）
  - 前端：Engagement创建表单（选择用户、部门、类型、起止日期、薪资方案）
  - 前端：Engagement列表页面（按部门/用户筛选）
  - 业务规则：短期义工需满足14天最短服务期验证
  - 状态管理：active/inactive/suspended

#### 2. 用户-部门分配
- **当前状况**：可在排班时指定部门，但无法查询某部门的所有志愿者
- **业务需求**：
  - 记录用户归属哪个部门（一个用户可属于多个部门）
  - 用于权限控制（部门负责人只能管理本部门的排班）
  - 用于统计报表（按部门统计志愿者数量、服务时长）
- **影响范围**：
  - 权限控制不够细化
  - 统计报表缺少部门维度
  - 无法实现"查看本部门志愿者"功能
- **预计时间**：1-2小时
- **依赖**：Engagement管理（用户通过engagement关联到部门）

---

### 🟡 中优先级（增强用户体验）

#### 3. 我的排班视图
- **当前状况**：志愿者无法查看自己的upcoming和past排班
- **业务需求**：
  - 志愿者需要知道自己何时需要服务
  - 查看历史排班记录
- **影响范围**：
  - 用户体验差，志愿者需要手动记录排班信息
  - 不影响核心功能（排班和考勤正常运行）
- **预计时间**：1-2小时
- **开发内容**：
  - 后端：schedules.mySchedules查询（返回当前用户的排班）
  - 前端：我的排班页面（upcoming/past分类，日历视图）

#### 4. 管理员仪表板
- **当前状况**：管理员无可视化界面查看系统统计数据
- **业务需求**：
  - 显示总志愿者数、总服务时长、活跃度等
  - 显示本月新注册用户、本月服务时长
  - 显示奖励兑换统计
- **影响范围**：
  - 管理员可通过数据库查询，但无可视化界面
  - 不影响核心功能
- **预计时间**：2-3小时
- **开发内容**：
  - 后端：dashboard.stats查询（聚合统计数据）
  - 前端：仪表板页面（卡片展示统计数据，图表可选）

---

### 🟢 低优先级（可延后）

#### 5. 寺工轮班规则（rota_rules）
- **当前状况**：数据库表已存在，但无API和UI
- **业务需求**：
  - 为固定班次的寺工自动生成月度排班
  - 例如：某寺工每周一、三、五上午8:00-12:00值班
- **影响范围**：
  - 可手动创建排班，自动化程度降低
  - 寺工数量较少时，手动操作可接受
- **预计时间**：3-4小时
- **依赖**：Engagement管理

#### 6. 用户管理界面
- **当前状况**：管理员需要通过数据库操作管理用户
- **业务需求**：
  - 查看所有用户列表
  - 编辑用户角色
  - 查看用户详情（积分、工时、兑换记录）
- **影响范围**：
  - 可通过数据库操作，但无UI界面
  - 不影响核心功能
- **预计时间**：2-3小时

#### 7. 奖励管理界面
- **当前状况**：管理员需要通过数据库操作管理奖励目录
- **业务需求**：
  - CRUD奖励目录（创建、编辑、删除奖励）
  - 调整积分成本、等级要求、库存
- **影响范围**：
  - 奖励目录不常变动，数据库操作可接受
  - 不影响核心功能
- **预计时间**：2-3小时

#### 8. 审计日志查看器
- **当前状况**：审计日志已记录，但无UI查看
- **业务需求**：
  - 管理员查看系统操作日志
  - 用于审计和问题排查
  - 按用户、操作类型、时间筛选
- **影响范围**：
  - 可通过数据库查询
  - 不影响核心功能
- **预计时间**：2-3小时

---

### 🆕 Phase 9新功能（积分配置与统计）

#### 9. 部门/岗位工时积分率配置
- **业务需求**：
  - 不同部门/岗位的工时积分转换率可能不同
  - 例如：体力劳动部门（斋堂）1小时=12积分，文案部门（图书馆）1小时=10积分
  - 寺工因承担更多责任，积分率可能更高（1小时=15积分）
- **当前状况**：
  - 统一1小时=10积分，无法差异化
  - 考勤确认时固定按10积分/小时计算
- **影响范围**：
  - 无法实现业务需求（义工和寺工积分差异化）
  - 无法体现不同岗位的贡献差异
- **预计时间**：3-4小时
- **依赖**：Engagement管理（需要知道用户的岗位类型）
- **开发内容**：
  - 数据库：新增points_rate_config表（部门ID、engagement类型、积分率）
  - 后端：pointsRateConfig router（CRUD配置）
  - 后端：修改考勤确认逻辑，根据engagement类型查询积分率
  - 前端：积分率配置界面（管理员操作）

#### 10. 积分统计报表
- **业务需求**：
  - 生成志愿者服务统计报表（按月/季度/年）
  - 生成部门工时统计报表
  - 生成积分获取/使用统计
  - 导出Excel/CSV格式
- **当前状况**：
  - 无报表功能，管理员需要手动查询数据库
- **影响范围**：
  - 寺院管理需要数据分析工具
  - 不影响核心功能
- **预计时间**：4-5小时
- **开发内容**：
  - 后端：reports router（志愿者统计、部门统计、积分统计）
  - 后端：导出Excel/CSV功能（使用exceljs或csv-writer库）
  - 前端：报表页面（选择报表类型、时间范围、导出按钮）

---

## 四、推荐开发顺序

### 步骤1: 完成Phase 4剩余功能（4-6小时）

**目标**：建立核心业务基础，支持义工/寺工区分

**任务清单**：
1. Engagement管理（义工/寺工关系创建、查询、状态管理）
   - 后端API：engagements router
   - 前端UI：Engagement创建表单、列表页面
   - 业务规则：14天最短服务期验证
   
2. 用户-部门分配界面
   - 后端API：userDepartments router（已有表，补充API）
   - 前端UI：在用户管理或Engagement管理中集成

**理由**：
- 这是核心业务逻辑，影响后续积分差异化计算
- 是Phase 9积分配置的前置依赖
- 完成后系统可正式区分义工和寺工

---

### 步骤2: 开发Phase 9核心功能（3-4小时）

**目标**：实现义工和寺工的积分差异化

**任务清单**：
1. 部门/岗位工时积分率配置
   - 数据库：新增points_rate_config表
   - 后端API：pointsRateConfig router（CRUD）
   - 修改考勤确认逻辑，根据engagement类型应用不同积分率
   - 前端UI：积分率配置页面（管理员操作）

2. 积分计算规则文档化
   - 更新BUSINESS_CONFIG.md，记录各部门/岗位的积分率
   - 更新DEVELOPMENT.md，说明积分计算逻辑

**理由**：
- 满足核心业务需求（义工和寺工积分差异化）
- 依赖步骤1的Engagement管理
- 完成后系统可灵活配置积分规则

---

### 步骤3: 增强用户体验（3-5小时）

**目标**：提升志愿者和管理员的使用体验

**任务清单**：
1. 我的排班视图（志愿者端）
   - 后端API：schedules.mySchedules
   - 前端UI：我的排班页面（upcoming/past，日历视图）

2. 管理员仪表板（系统统计）
   - 后端API：dashboard.stats
   - 前端UI：仪表板页面（卡片展示统计数据）

**理由**：
- 志愿者需要查看自己的排班安排
- 管理员需要可视化的系统概览
- 不影响核心功能，但显著提升体验

---

### 步骤4: 开发Phase 9报表功能（4-5小时）

**目标**：为寺院管理提供数据分析工具

**任务清单**：
1. 志愿者服务统计报表
   - 按月/季度/年统计服务时长、积分获取
   - 志愿者活跃度排名

2. 部门工时统计报表
   - 按部门统计总服务时长、志愿者数量
   - 部门积分发放统计

3. 积分获取/使用统计
   - 积分来源分析（考勤、奖励积分）
   - 积分使用分析（兑换奖励）

4. 导出Excel/CSV功能
   - 使用exceljs或csv-writer库
   - 支持自定义时间范围

**理由**：
- 寺院管理需要数据分析和决策支持
- 报表可用于年度总结、表彰优秀志愿者
- 不影响核心功能，但提升管理效率

---

### 步骤5: 完善管理工具（可选，8-10小时）

**目标**：降低系统维护成本，减少数据库直接操作

**任务清单**：
1. 用户管理界面（查看、编辑、角色管理）
2. 奖励管理界面（CRUD奖励目录）
3. 审计日志查看器（筛选、搜索）
4. 寺工轮班规则（自动生成月度排班）

**理由**：
- 降低系统维护成本
- 提升管理员操作便利性
- 可根据实际需求决定是否开发

---

## 五、关键决策点

### 决策1: 是否立即完成Phase 4的Engagement管理？

**选项**：
- A. 是 - 这是核心业务逻辑，应优先完成
- B. 否 - 先开发Phase 9积分配置，稍后再补充Engagement

**推荐**: **选A**

**理由**：
- Engagement管理是后续功能的基础
- 没有Engagement，无法区分义工和寺工，积分配置无法实现
- 影响业务逻辑的完整性

---

### 决策2: Phase 9的范围是否调整为"工时积分配置与统计报表"？

**选项**：
- A. 是 - 移除payroll相关功能，专注积分系统
- B. 否 - 保留payroll功能（但寺院不需要）

**推荐**: **选A**

**理由**：
- 根据业务需求，系统只负责积分，薪资由财务部管理
- 简化系统，避免涉及劳动法、税务等复杂问题
- 符合寺院"奉献"而非"雇佣"的理念

---

### 决策3: 是否需要在Phase 9之前完成"我的排班视图"？

**选项**：
- A. 是 - 这是志愿者的核心需求，应优先
- B. 否 - 可以延后，先完成积分配置

**推荐**: **选B**

**理由**：
- 积分配置是业务核心需求，更重要
- 排班视图是体验增强功能，可以稍后添加
- 当前志愿者可通过日历视图查看排班（虽然不够便捷）

---

## 六、总结与建议

### 当前系统状态

**整体完成度**: 约80%

**核心功能**: 已完成
- ✅ 用户注册与认证
- ✅ 部门管理
- ✅ 排班与考勤
- ✅ 工时与积分自动计算
- ✅ 7级会员体系与欢喜徽记
- ✅ 奖励商城与兑换流程
- ✅ 工作人员验证
- ✅ 权限控制与审计日志

**主要缺失**:
1. Engagement管理（义工/寺工关系）- 影响积分差异化
2. 部门工时积分率配置 - 当前统一10积分/小时
3. 统计报表功能 - 管理员需要数据分析工具

---

### 建议开发路径

**总体策略**: 先补齐核心业务逻辑，再增强用户体验，最后完善管理工具

**具体步骤**:
1. **步骤1** (4-6小时): 完成Phase 4剩余功能（Engagement管理）→ 建立业务基础
2. **步骤2** (3-4小时): 开发Phase 9核心功能（积分配置）→ 实现差异化积分
3. **步骤3** (3-5小时): 增强用户体验（我的排班、管理员仪表板）→ 提升系统完整度
4. **步骤4** (4-5小时): 开发Phase 9报表功能（统计报表、导出）→ 支持数据分析
5. **步骤5** (可选，8-10小时): 完善管理工具（用户管理、奖励管理、审计日志查看器）

**预计总时间**: 15-20小时完成所有高优先级功能

---

### 下一步行动

**等待您的确认**:
1. ✅ 确认Phase 9调整为"工时积分配置与统计报表"（移除payroll）
2. ✅ 确认开发顺序：Phase 4剩余 → Phase 9核心 → 用户体验 → 报表功能
3. ⚠️ 提供业务配置信息（见BUSINESS_CONFIG.md）：
   - 完整的部门列表及工时积分率
   - 完整的奖励目录
   - 等级积分阈值确认
   - 其他业务规则

**确认后立即开始**:
- 开发Engagement管理（后端API + 前端UI）
- 实现14天最短服务期验证
- 完成用户-部门分配功能

---

**报告完毕，等待您的指示！**
